const { exec } = require('child_process'); 
const simpleGit = require('simple-git');  
const { Sequelize, DataTypes } = require('sequelize');

const sequelize = new Sequelize('mysql://user:password@localhost:3306/vulnerabilities');

const Repository = sequelize.define('Repository', {
  github_url: {
    type: DataTypes.STRING,
    allowNull: false
  }
});

async function cloneAndRunExploits() {
  try {
    const repositories = await Repository.findAll();

    const git = simpleGit();

    for (const repo of repositories) {
      const repoUrl = repo.github_url;

      const repoName = repoUrl.split('/').pop().replace('.git', '');
      console.log(`Клонируем репозиторий: ${repoUrl}`);

      await git.clone(repoUrl, `./${repoName}`);
      console.log(`Репозиторий ${repoName} успешно клонирован.`);

      process.chdir(`./${repoName}`);

      console.log(`Запуск эксплойтов для репозитория ${repoName}`);

      exec('node exploit.js', (error, stdout, stderr) => {
        if (error) {
          console.error(`Ошибка при выполнении эксплойта: ${error.message}`);
          return;
        }
        if (stderr) {
          console.error(`Ошибка в процессе выполнения: ${stderr}`);
          return;
        }
        console.log(`Результат выполнения эксплойта:\n${stdout}`);
      });

      process.chdir('..');
    }

  } catch (error) {
    console.error(`Ошибка при обработке репозиториев: ${error.message}`);
  }
}

cloneAndRunExploits();
